<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="main.css">
    <title>JSON整形</title>
</head>
<body>
    <header>
        <span>JSON整形</span>
        <button id="header_btn">≡</button>
        <div id="header_link"></div>
    </header>
    <main style="padding:6px 0 0 1px">
        <textarea name="" id="in_a" cols="29" rows="10" placeholder="入力"></textarea>
        <textarea name="" id="out_a" cols="29" rows="10" placeholder="出力"></textarea>
    </main>
    <script src="main.js"></script>
    <script>
        (function(){
            function main(){
                let in_a = document.getElementById("in_a");
                let out_a = document.getElementById("out_a");
                in_a.addEventListener("input", ()=>{
                    let in_val = in_a.value;
                    let out_val = "";
                    let flag = {
                        quote: false,
                        indent: 0,
                        error: false,
                    };

                    for(let i=0; i<in_val.length; ++i){
                        if(flag.quote){
                            switch(in_val[i]){
                                case "\"":
                                    flag.quote = false;
                                    out_val += in_val[i];
                                    break;
                                default:
                                    out_val += in_val[i];
                                    break;
                            }
                        }else{
                            switch(in_val[i]){
                                case "\"":
                                    flag.quote = true;
                                    out_val += in_val[i];
                                    break;
                                case ":":
                                    out_val += " " + in_val[i] + " ";
                                    break;
                                case "\t": // フォールスルー
                                case " ": // フォールスルー
                                    break;
                                case ",":
                                    if(flag.indent > 0){
                                        out_val += in_val[i] + "\n" + "\t".repeat(flag.indent);
                                    }else{
                                        out_val += in_val[i] + "\n";
                                    }
                                    break;
                                case "[": // フォールスルー
                                case "{":
                                    ++flag.indent;
                                    out_val += in_val[i] + "\n" + "\t".repeat(flag.indent);
                                    break;
                                case "]": // フォールスルー
                                case "}":
                                    --flag.indent;
                                    if(flag.indent > 0){
                                        out_val += "\n" + in_val[i] + "\n" + "\t".repeat(flag.indent);
                                    }else{
                                        out_val += "\n" +in_val[i];
                                        if(flag.indent < 0){
                                            flag.error = true;
                                        }
                                    }
                                    break;
                                default:
                                    out_val += in_val[i];
                                    break;
                            }
                        }
                        
                    }

                    out_a.value = out_val;
                    if(flag.error){
                        out_a.style.backgroundColor = "#dd5522";
                    }else{
                        out_a.style.backgroundColor = null;
                    }
                });
                function OnTabKey( e, obj ){
                    // タブキーが押された時以外は即リターン
                    if( e.keyCode!=9 ){ return; }
                    // タブキーを押したときのデフォルトの挙動を止める
                    e.preventDefault();
                    // 現在のカーソルの位置と、カーソルの左右の文字列を取得しておく
                    let cursorPosition = obj.selectionStart;
                    let cursorLeft     = obj.value.substr( 0, cursorPosition );
                    let cursorRight    = obj.value.substr( cursorPosition, obj.value.length );
                    // テキストエリアの中身を、
                    // 「取得しておいたカーソルの左側」+「タブ」+「取得しておいたカーソルの右側」
                    // という状態にする。
                    obj.value = cursorLeft+"\t"+cursorRight;
                    // カーソルの位置を入力したタブの後ろにする
                    obj.selectionEnd = cursorPosition+1;
                }
                in_a.addEventListener("keydown", (e)=>{
                    OnTabKey( e, in_a );
                });
                out_a.addEventListener("keydown", (e)=>{
                    OnTabKey( e, out_a );
                });
            }
            main();
        })();
    </script>
</body>
</html>